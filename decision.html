<!DOCTYPE html>
<html class="dark" lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>D√©cisions (NIRD/Obsolescence/Big Tech)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script src="data.js"></script>
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#c81e1e",
                        "secondary": "#166534",
                        "terminal-bg": "#121212",
                        "terminal-border": "#333333",
                        "neon-red": "#ff3333",
                        "neon-green": "#00ff66",
                        "neon-blue": "#00ccff",
                        "text-light": "#e0e0e0",
                        "text-dark": "#a0a0a0",
                        "success": "#00ff66",
                        "danger": "#ff3333",
                        "warning": "#ffff00",
                    },
                    fontFamily: {
                        "mono": ["'Roboto Mono'", "monospace"],
                    },
                    boxShadow: {
                        'glitch-red': '3px 3px 0px 0px #ff3333, -3px -3px 0px 0px #333333',
                        'glitch-green': '3px 3px 0px 0px #00ff66, -3px -3px 0px 0px #333333',
                        'glitch-blue': '3px 3px 0px 0px #00ccff, -3px -3px 0px 0px #333333',
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        .glitch-border { clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%); }
        .text-shadow-neon { text-shadow: 0 0 5px currentColor; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        /* === ANIMATIONS 2D POUR CHOIX === */
        @keyframes floatUp { from { opacity: 0; transform: translateY(0) scale(0.8); } to { opacity: 0; transform: translateY(-80px) scale(1.2); } }
        @keyframes floatDown { from { opacity: 0; transform: translateY(0) scale(0.8); } to { opacity: 0; transform: translateY(80px) scale(1.2); } }
        @keyframes spinOut { from { opacity: 1; transform: rotate(0deg) scale(1); } to { opacity: 0; transform: rotate(360deg) scale(0); } }
        @keyframes pulseGrow { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        @keyframes slideLeft { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideRight { from { opacity: 0; transform: translateX(-100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes glowPulse { 0%, 100% { filter: drop-shadow(0 0 0px); } 50% { filter: drop-shadow(0 0 15px); } }
        @keyframes particle { 0% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes waveEffect { 0% { clip-path: polygon(0 50%, 100% 50%, 100% 100%, 0 100%); } 50% { clip-path: polygon(0 30%, 100% 30%, 100% 100%, 0 100%); } 100% { clip-path: polygon(0 50%, 100% 50%, 100% 100%, 0 100%); } }
        
        /* √âl√©ments d'animation */
        .choice-particle { position: fixed; pointer-events: none; font-size: 2rem; font-weight: bold; }
        .choice-animation-container { position: fixed; top: 50%; left: 50%; pointer-events: none; width: 100%; height: 100%; }
        
        .float-animation { animation: floatUp 2s ease-out forwards; }
        .sink-animation { animation: floatDown 2s ease-out forwards; }
        .spin-animation { animation: spinOut 1.5s ease-in forwards; }
        .pulse-animation { animation: pulseGrow 0.6s ease-in-out; }
        .glow-animation { animation: glowPulse 1.5s ease-in-out; }
        .wave-animation { animation: waveEffect 2s ease-in-out infinite; }
        
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: #121212; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .chat-scroll::-webkit-scrollbar-thumb:hover { background: #00ccff; }
    </style>
</head>

<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Navigation - Village Num√©rique R√©sistant</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#c81e1e",
                        "secondary": "#166534",
                        "terminal-bg": "#121212",
                        "terminal-border": "#333333",
                        "neon-red": "#ff3333",
                        "neon-green": "#00ff66",
                        "neon-blue": "#00ccff",
                        "text-light": "#e0e0e0",
                        "text-dark": "#a0a0a0",
                        "warning": "#ffff00",
                    },
                    fontFamily: {
                        "mono": ["'Roboto Mono'", "monospace"],
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { 
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; 
            vertical-align: middle; 
        }
        
        .navbar-link {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .navbar-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #00ff66, #00ccff);
            transition: width 0.3s ease;
        }
        
        .navbar-link:hover::after,
        .navbar-link.active::after {
            width: 100%;
        }
        
        .navbar-link.active {
            color: #00ff66;
        }
        
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        .glitch-text {
            animation: glitch 3s infinite;
        }
        
        @keyframes glitch {
            0%, 90%, 100% { 
                text-shadow: 1px 0 #ff3333, -1px 0 #00ccff; 
            }
            95% { 
                text-shadow: -1px 0 #ff3333, 1px 0 #00ccff; 
                transform: skewX(5deg); 
            }
            96% { 
                text-shadow: 1px 0 #ff3333, -1px 0 #00ccff; 
                transform: skewX(0deg); 
            }
        }
    </style>
</head>
<body class="bg-black font-mono text-text-light">

<!-- NAVBAR PRINCIPALE -->
<nav class="bg-black border-b-2 border-terminal-border sticky top-0 z-50 backdrop-blur-sm bg-black/95">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            
            <!-- LOGO -->
            <div class="flex items-center gap-3">
                <a href="index.html" class="flex items-center gap-2 group">
                    <span class="material-symbols-outlined text-3xl text-neon-green group-hover:text-neon-blue transition-colors">terminal</span>
                    <span class="text-xl font-bold text-white glitch-text hidden sm:inline">VNR</span>
                    <span class="text-xs text-text-dark hidden md:inline">v1.0</span>
                </a>
            </div>

            <!-- MENU DESKTOP -->
            <div class="hidden md:flex items-center gap-6">
                <a href="index.html" class="navbar-link text-text-light hover:text-neon-green flex items-center gap-2 py-2">
                    <span class="material-symbols-outlined text-lg">home</span>
                    <span class="text-sm font-medium">Accueil</span>
                </a>
                
                <a href="decision.html" class="navbar-link text-text-light hover:text-neon-green flex items-center gap-2 py-2">
                    <span class="material-symbols-outlined text-lg">dashboard</span>
                    <span class="text-sm font-medium">D√©cisions</span>
                </a>
                
                <a href="klub.html" class="navbar-link text-text-light hover:text-neon-green flex items-center gap-2 py-2">
                    <span class="material-symbols-outlined text-lg">celebration</span>
                    <span class="text-sm font-medium">KLUB</span>
                </a>

                <div class="h-6 w-px bg-terminal-border"></div>

                <!-- INFOS STATUS -->
                <div class="flex items-center gap-2 text-xs">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-neon-green opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-neon-green"></span>
                    </span>
                    <span class="text-neon-green font-bold">ONLINE</span>
                </div>
            </div>

            <!-- BOUTON MENU MOBILE -->
            <button onclick="toggleMobileMenu()" class="md:hidden text-neon-blue hover:text-neon-green transition-colors">
                <span class="material-symbols-outlined text-3xl" id="menu-icon">menu</span>
            </button>
        </div>
    </div>

    <!-- MENU MOBILE -->
    <div id="mobile-menu" class="mobile-menu md:hidden fixed top-16 left-0 w-64 h-screen bg-black border-r-2 border-terminal-border z-40">
        <div class="flex flex-col p-4 gap-2">
            <a href="index.html" class="navbar-link text-text-light hover:text-neon-green hover:bg-terminal-border flex items-center gap-3 p-3 rounded transition-all">
                <span class="material-symbols-outlined">home</span>
                <span class="font-medium">Accueil</span>
            </a>
            
            <a href="decision.html" class="navbar-link text-text-light hover:text-neon-green hover:bg-terminal-border flex items-center gap-3 p-3 rounded transition-all">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="font-medium">D√©cisions</span>
            </a>
            
            <a href="klub.html" class="navbar-link text-text-light hover:text-neon-green hover:bg-terminal-border flex items-center gap-3 p-3 rounded transition-all">
                <span class="material-symbols-outlined">celebration</span>
                <span class="font-medium">KLUB</span>
            </a>

            <div class="h-px bg-terminal-border my-2"></div>

            <div class="p-3 border border-terminal-border rounded bg-white/5">
                <p class="text-xs text-text-dark mb-2">STATUS SYST√àME:</p>
                <div class="flex items-center gap-2 text-neon-green text-sm">
                    <span class="material-symbols-outlined text-sm">check_circle</span>
                    <span>ONLINE</span>
                </div>
                <p class="text-xs text-text-dark mt-3 mb-2">CONNEXION:</p>
                <div class="flex items-center gap-2 text-warning text-sm">
                    <span class="material-symbols-outlined text-sm">lock</span>
                    <span>S√âCURIS√âE</span>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- OVERLAY POUR FERMER LE MENU MOBILE -->
<div id="overlay" class="hidden fixed inset-0 bg-black/50 z-30 md:hidden" onclick="toggleMobileMenu()"></div>

<!-- SCRIPT JAVASCRIPT -->
<script>
    // Gestion du menu mobile
    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        const overlay = document.getElementById('overlay');
        const icon = document.getElementById('menu-icon');
        
        menu.classList.toggle('open');
        overlay.classList.toggle('hidden');
        
        if (menu.classList.contains('open')) {
            icon.textContent = 'close';
        } else {
            icon.textContent = 'menu';
        }
    }

    // Fermer le menu en cliquant sur un lien
    document.querySelectorAll('#mobile-menu a').forEach(link => {
        link.addEventListener('click', () => {
            toggleMobileMenu();
        });
    });

    // Marquer la page active
    window.addEventListener('DOMContentLoaded', () => {
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('.navbar-link').forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });
    });
</script>
<body class="bg-black font-mono text-text-light">
<div class="flex h-screen w-full relative">
    
    <aside class="flex w-64 flex-col bg-black border-r border-terminal-border p-4 hidden md:flex">
        <div class="flex flex-col gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border border-terminal-border" style='background-image: url("https://ui-avatars.com/api/?name=LN&background=0D8ABC&color=fff");'></div>
                <div class="flex flex-col">
                    <h1 class="text-white text-base font-medium leading-normal">Lyc√©e Num√©rique</h1>
                    <p class="text-text-dark text-sm font-normal leading-normal">// Tableau de Bord</p>
                </div>
            </div>
            <nav class="flex flex-col gap-2 mt-4">
                <button onclick="switchView('game')" class="flex w-full items-center gap-3 px-3 py-2 text-text-dark hover:bg-terminal-border hover:text-white rounded text-left focus:bg-terminal-border focus:text-white">
                    <span class="material-symbols-outlined text-2xl">dashboard</span>
                    <p class="text-sm font-medium">D√©cisions</p>
                </button>
                <button onclick="switchView('shop')" class="flex w-full items-center gap-3 px-3 py-2 text-neon-blue bg-neon-blue/5 border border-neon-blue/30 rounded text-left hover:bg-neon-blue/10">
                    <span class="material-symbols-outlined text-2xl !font-bold">shopping_cart</span>
                    <p class="text-sm font-medium">Achats / Bonus</p>
                </button>
                <div class="h-px bg-terminal-border my-2"></div>
                <div class="px-3 text-xs text-text-dark">INFRASTRUCTURE</div>
                <div class="flex items-center gap-3 px-3 py-1 text-text-dark">
                    <span class="material-symbols-outlined text-lg text-neon-green">check_circle</span>
                    <span class="text-xs">Serveur NIRD: ON</span>
                </div>
                
                <!-- VISUALISEUR AUDIO -->
                <div class="mt-6 mx-3 p-3 border border-neon-blue/30 bg-neon-blue/5 rounded">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-xs text-neon-blue font-bold">AUDIO SPECTRUM</div>
                        <div class="flex gap-2">
                            <button id="mic-toggle" onclick="toggleMic()" class="text-xs text-text-dark hover:text-neon-blue flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">mic</span>
                            </button>
                            <button id="system-toggle" onclick="toggleSystemAudio()" class="text-xs text-text-dark hover:text-neon-blue flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">volume_up</span>
                            </button>
                        </div>
                    </div>
                    <canvas id="audio-visualizer" width="200" height="100" class="w-full bg-black/50 rounded"></canvas>
                    <div class="text-xs text-text-dark mt-2 text-center" id="audio-info">Cliquez sur les ic√¥nes pour activer</div>
                </div>
            </nav>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen">
        <header class="flex items-center justify-between p-4 border-b border-terminal-border bg-black">
            <div class="flex flex-wrap gap-4">
                <div class="flex items-center gap-3 min-w-[158px] rounded p-3 border border-terminal-border bg-black">
                    <span class="material-symbols-outlined text-neon-green text-3xl">account_balance_wallet</span>
                    <div>
                        <p class="text-text-dark text-xs font-medium">Budget</p>
                        <p id="header-budget" class="text-white tracking-light text-xl font-bold leading-tight">‚Ç¨ 50,000</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 min-w-[158px] rounded p-3 border border-terminal-border bg-black">
                    <span class="material-symbols-outlined text-neon-green text-3xl">model_training</span>
                    <div>
                        <p class="text-text-dark text-xs font-medium">Autonomie</p>
                        <p id="header-autonomy" class="text-white tracking-light text-xl font-bold leading-tight">15%</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 min-w-[158px] rounded p-3 border border-terminal-border bg-black">
                    <span class="material-symbols-outlined text-neon-green text-3xl">eco</span>
                    <div>
                        <p class="text-text-dark text-xs font-medium">√âcologie</p>
                        <p id="header-eco" class="text-white tracking-light text-xl font-bold leading-tight">65/100</p>
                    </div>
                </div>
            </div>
            <div class="text-right hidden sm:block">
                <p id="header-turn" class="text-white font-semibold">Tour 1</p>
                <p class="text-xs text-text-dark uppercase tracking-widest">En attente d'ordre</p>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-8 flex flex-col items-center bg-black bg-[radial-gradient(ellipse_80%_80%_at_50%_-20%,rgba(120,119,198,0.2),rgba(255,255,255,0))]">
            
            <div id="game-view" class="w-full max-w-6xl fade-in">
                <h1 id="scenario-title" class="text-white tracking-light text-3xl md:text-4xl font-bold leading-tight text-center">INITIALISATION...</h1>
                <p id="scenario-desc" class="text-text-dark text-base font-normal leading-normal text-center mt-4 max-w-3xl mx-auto"></p>
                <div id="feedback-area" class="hidden mt-6 p-4 bg-white/5 border-l-4 border-neon-blue text-white rounded shadow-lg max-w-3xl mx-auto"></div>
                <div id="choices-container" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8"></div>
            </div>

            <div id="shop-view" class="hidden w-full max-w-6xl fade-in">
                <div class="mb-6 flex items-center justify-between">
                    <h2 class="text-3xl font-bold text-neon-blue text-shadow-neon">MARCH√â DES RESSOURCES</h2>
                    <button onclick="switchView('game')" class="text-sm border border-terminal-border px-4 py-2 hover:bg-white/10 rounded">RETOUR AU JEU</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="shop-container"></div>
                <div class="mt-8 p-4 border border-warning/30 bg-warning/5 rounded text-warning text-sm flex gap-3 items-start">
                    <span class="material-symbols-outlined">info</span>
                    <p>Les acquisitions prennent effet imm√©diatement.</p>
                </div>
            </div>

        </div>
    </main>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-4">
        
        <div id="chatbot-window" class="hidden w-80 h-96 bg-black border border-neon-blue shadow-[0_0_15px_rgba(0,204,255,0.3)] flex flex-col transition-all duration-300 transform scale-95 origin-bottom-right">
            <div class="bg-neon-blue/10 p-3 border-b border-neon-blue/30 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-neon-blue opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-neon-blue"></span>
                    </span>
                    <span class="text-neon-blue font-bold text-sm">TROLL_BOT v0.1</span>
                </div>
                <button onclick="toggleChat()" class="text-neon-blue hover:text-white"><span class="material-symbols-outlined text-lg">close</span></button>
            </div>
            
            <div id="chat-messages" class="flex-1 p-3 overflow-y-auto chat-scroll space-y-3">
                <div class="flex flex-col items-start">
                    <div class="bg-terminal-border text-xs text-text-light p-2 rounded-lg rounded-tl-none max-w-[85%]">
                        Salut humain. Je suis l√† pour t'ignorer. Pose une question que je rigole. Mot cl√©: aide, conseil, budget, linux, gafam, score...
                    </div>
                </div>
            </div>

            <div class="p-3 border-t border-terminal-border bg-black flex gap-2">
                <input id="chat-input" type="text" placeholder="Essaye de me parler..." class="flex-1 bg-terminal-bg border border-terminal-border text-white text-xs p-2 rounded focus:border-neon-blue focus:outline-none" onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="bg-neon-blue/20 text-neon-blue p-2 rounded hover:bg-neon-blue hover:text-black transition-colors">
                    <span class="material-symbols-outlined text-lg">send</span>
                </button>
            </div>
        </div>

        <button onclick="toggleChat()" class="h-14 w-14 bg-black border-2 border-neon-blue rounded-full shadow-[0_0_10px_rgba(0,204,255,0.5)] flex items-center justify-center text-neon-blue hover:bg-neon-blue hover:text-black transition-all hover:scale-110">
            <span class="material-symbols-outlined text-3xl">smart_toy</span>
        </button>
    </div>

</div>

<script>
    // --- VARIABLES D'√âTAT ---
    let tour = 1; 
    let choicesHistory = []; // Historique des choix
    let unlockedChoices = {}; // Choix d√©bloqu√©s par sc√©nario
    let blockedChoices = {}; // Choix bloqu√©s par sc√©nario
    let blockReasons = {}; // Raisons de blocage dynamiques (quel choix a caus√© le blocage)

    // Lecture URL
    const urlParams = new URLSearchParams(window.location.search);
    const difficulty = urlParams.get('diff') || 'normal';
    if(difficulty === 'easy') { budget = 70; autonomie = 20; }
    if(difficulty === 'hard') { budget = 20; autonomie = 5; ecologie = 50; }

    // --- ACHIEVEMENTS NOTIFICATIONS ---
    function triggerAchievementNotification(achievement) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-neon-blue to-neon-green border-2 border-neon-green p-4 rounded text-white shadow-lg animate-pulse z-50 max-w-xs';
        notification.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-2xl">verified</span>
                <div>
                    <h4 class="font-bold">${achievement.name}</h4>
                    <p class="text-xs opacity-90">${achievement.desc}</p>
                </div>
            </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 4000);
    }

    // === ANIMATIONS 2D POUR CHOIX ===
    function playChoiceAnimation(choice, index) {
        const container = document.body;
        const type = choice.type;
        
        // Cr√©er un conteneur pour les animations
        const animContainer = document.createElement('div');
        animContainer.className = 'choice-animation-container';
        container.appendChild(animContainer);
        
        if (type === 'goliath') {
            // Animation Goliath: Descente avec effet de crash
            playGoliathAnimation(animContainer, choice);
        } else if (type === 'david') {
            // Animation David: Bounce √©quilibr√©
            playDavidAnimation(animContainer, choice);
        } else if (type === 'nird') {
            // Animation NIRD: Spirale technologique
            playNirdAnimation(animContainer, choice);
        }
        
        // Nettoyer apr√®s animation
        setTimeout(() => animContainer.remove(), 2500);
    }

    // Goliath: Chute rouge avec √©clat
    function playGoliathAnimation(container, choice) {
        const emoji = 'üî¥';
        const color = '#ff3333';
        
        // Cr√©er 5 particules qui tombent
        for (let i = 0; i < 5; i++) {
            const particle = document.createElement('div');
            particle.textContent = emoji;
            particle.className = 'choice-particle sink-animation';
            particle.style.left = (Math.random() * window.innerWidth) + 'px';
            particle.style.top = '-50px';
            particle.style.color = color;
            particle.style.textShadow = `0 0 10px ${color}`;
            particle.style.animation = `floatDown ${1.5 + i * 0.2}s ease-in forwards`;
            container.appendChild(particle);
        }
        
        // Cr√©er un texte central qui se dissout
        const centerText = document.createElement('div');
        centerText.textContent = choice.title.substring(0, 15) + '...';
        centerText.style.position = 'fixed';
        centerText.style.top = '50%';
        centerText.style.left = '50%';
        centerText.style.transform = 'translate(-50%, -50%)';
        centerText.style.color = color;
        centerText.style.fontSize = '2rem';
        centerText.style.fontWeight = 'bold';
        centerText.style.animation = 'spinOut 1.5s ease-in forwards';
        centerText.style.textShadow = `0 0 20px ${color}`;
        container.appendChild(centerText);
    }

    // David: Animation de bounce √©quilibr√©
    function playDavidAnimation(container, choice) {
        const emoji = 'üü¢';
        const color = '#00ff66';
        
        // Cr√©er 3 ondes qui se propagent
        for (let i = 0; i < 3; i++) {
            const wave = document.createElement('div');
            wave.style.position = 'fixed';
            wave.style.top = '50%';
            wave.style.left = '50%';
            wave.style.width = '100px';
            wave.style.height = '100px';
            wave.style.border = `2px solid ${color}`;
            wave.style.borderRadius = '50%';
            wave.style.transform = 'translate(-50%, -50%)';
            wave.style.animation = `pulse${i} 1.2s ease-out forwards`;
            wave.style.opacity = '0.6';
            container.appendChild(wave);
            
            // Cr√©er l'animation CSS dynamiquement
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse${i} {
                    0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(${3 + i}); opacity: 0; }
                }
            `;
            container.appendChild(style);
        }
        
        // Texte central qui pulse
        const centerText = document.createElement('div');
        centerText.textContent = emoji;
        centerText.style.position = 'fixed';
        centerText.style.top = '50%';
        centerText.style.left = '50%';
        centerText.style.transform = 'translate(-50%, -50%)';
        centerText.style.fontSize = '3rem';
        centerText.style.animation = 'pulseGrow 0.8s ease-in-out';
        centerText.style.filter = `drop-shadow(0 0 20px ${color})`;
        container.appendChild(centerText);
    }

    // NIRD: Animation spirale technologique
    function playNirdAnimation(container, choice) {
        const emoji = 'ü§ì';
        const color = '#00ccff';
        
        // Cr√©er des particules en spirale
        const particleCount = 8;
        for (let i = 0; i < particleCount; i++) {
            const angle = (i / particleCount) * Math.PI * 2;
            const particle = document.createElement('div');
            particle.textContent = i % 2 === 0 ? '‚öôÔ∏è' : 'üîß';
            particle.style.position = 'fixed';
            particle.style.top = '50%';
            particle.style.left = '50%';
            particle.style.fontSize = '1.5rem';
            particle.style.animation = `orbit${i} 1.5s ease-out forwards`;
            container.appendChild(particle);
            
            // Animation orbitale
            const style = document.createElement('style');
            const distance = 150;
            const endX = Math.cos(angle) * distance;
            const endY = Math.sin(angle) * distance;
            style.textContent = `
                @keyframes orbit${i} {
                    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    100% { transform: translate(calc(-50% + ${endX}px), calc(-50% + ${endY}px)) scale(0); opacity: 0; }
                }
            `;
            container.appendChild(style);
        }
        
        // Texte central rotatif
        const centerText = document.createElement('div');
        centerText.textContent = emoji;
        centerText.style.position = 'fixed';
        centerText.style.top = '50%';
        centerText.style.left = '50%';
        centerText.style.transform = 'translate(-50%, -50%)';
        centerText.style.fontSize = '3rem';
        centerText.style.animation = 'spinOut 1.5s ease-in-out forwards';
        centerText.style.filter = `drop-shadow(0 0 15px ${color})`;
        container.appendChild(centerText);
    }

    // Animation du personnage d√©sactiv√©e
    
    function drawCharacter() {
        const canvas = document.getElementById('character-canvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        
        // Effacer le canvas avec d√©grad√© de fond
        const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        bgGradient.addColorStop(0, 'rgba(18, 18, 18, 1)');
        bgGradient.addColorStop(1, 'rgba(30, 30, 50, 1)');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Incr√©menter le compteur d'animation
        characterAnimationFrame++;
        
        // D√©terminer l'√©tat du personnage
        const autonomyRatio = autonomie / 100;
        const ecologyRatio = ecologie / 100;
        const choiceRatio = (choicesHistory.filter(c => c.type !== 'goliath').length) / Math.max(1, choicesHistory.length);
        
        // Calculs d'animation
        const breatheOffset = Math.sin(characterAnimationFrame * 0.05) * 3;
        const floatOffset = Math.sin(characterAnimationFrame * 0.03) * 8;
        const walkCycle = Math.sin(characterAnimationFrame * 0.08);
        const headBob = Math.sin(characterAnimationFrame * 0.04) * 3;
        
        ctx.save();
        ctx.translate(centerX, centerY + floatOffset);
        
        // === OMBRE DU PERSONNAGE ===
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.beginPath();
        ctx.ellipse(0, 120, 40 - floatOffset / 2, 8, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // === JAMBES ===
        const legColor = getCharacterColor();
        const legSwing = walkCycle * 15;
        
        // Jambe gauche
        ctx.save();
        ctx.translate(-15, 40);
        ctx.rotate((legSwing * Math.PI) / 180);
        ctx.fillStyle = legColor;
        ctx.filter = 'brightness(0.8)';
        drawRoundRect(ctx, -8, 0, 16, 45, 8);
        ctx.fill();
        // Pied gauche
        ctx.fillStyle = getCharacterColor();
        ctx.filter = 'brightness(0.6)';
        ctx.beginPath();
        ctx.ellipse(0, 45, 10, 6, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        
        // Jambe droite
        ctx.save();
        ctx.translate(15, 40);
        ctx.rotate((-legSwing * Math.PI) / 180);
        ctx.fillStyle = legColor;
        ctx.filter = 'brightness(0.8)';
        drawRoundRect(ctx, -8, 0, 16, 45, 8);
        ctx.fill();
        // Pied droit
        ctx.fillStyle = getCharacterColor();
        ctx.filter = 'brightness(0.6)';
        ctx.beginPath();
        ctx.ellipse(0, 45, 10, 6, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        
        ctx.filter = 'none';
        
        // === CORPS PRINCIPAL ===
        const bodyGradient = ctx.createLinearGradient(-35, -60, 35, 60);
        const mainColor = getCharacterColor();
        bodyGradient.addColorStop(0, mainColor);
        bodyGradient.addColorStop(0.5, lightenColor(mainColor, 20));
        bodyGradient.addColorStop(1, darkenColor(mainColor, 20));
        
        ctx.fillStyle = bodyGradient;
        // Ombre r√©duite pour performance
        if (characterAnimationFrame % 3 === 0) {
            ctx.shadowColor = getCharacterGlow();
            ctx.shadowBlur = 10;
        }
        drawRoundRect(ctx, -35, -60, 70, 100 + breatheOffset, 20);
        ctx.fill();
        ctx.shadowBlur = 0;
        
        // === BRAS ===
        const armSwing = walkCycle * 20;
        
        // Bras gauche
        ctx.save();
        ctx.translate(-35, -30);
        ctx.rotate((armSwing * Math.PI) / 180);
        ctx.fillStyle = mainColor;
        ctx.filter = 'brightness(0.9)';
        drawRoundRect(ctx, -10, 0, 20, 50, 10);
        ctx.fill();
        // Main gauche
        ctx.beginPath();
        ctx.arc(0, 50, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        
        // Bras droit
        ctx.save();
        ctx.translate(35, -30);
        ctx.rotate((-armSwing * Math.PI) / 180);
        ctx.fillStyle = mainColor;
        ctx.filter = 'brightness(0.9)';
        drawRoundRect(ctx, -10, 0, 20, 50, 10);
        ctx.fill();
        // Main droite
        ctx.beginPath();
        ctx.arc(0, 50, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        
        ctx.filter = 'none';
        
        // === T√äTE ===
        const headRotation = Math.sin(characterAnimationFrame * 0.04) * 0.08;
        ctx.save();
        ctx.translate(0, -85 + headBob);
        ctx.rotate(headRotation);
        
        // T√™te avec d√©grad√©
        const headGradient = ctx.createRadialGradient(0, 0, 10, 0, 0, 30);
        headGradient.addColorStop(0, lightenColor(mainColor, 30));
        headGradient.addColorStop(1, mainColor);
        ctx.fillStyle = headGradient;
        ctx.beginPath();
        ctx.arc(0, 0, 30, 0, Math.PI * 2);
        ctx.fill();
        
        // Cheveux/Chapeau selon autonomie
        if (autonomie > 60) {
            // Couronne de libert√© (simplifi√©e)
            ctx.fillStyle = '#FFD700';
            for (let i = 0; i < 5; i++) {
                const angle = (i * Math.PI * 2) / 5 - Math.PI / 2;
                ctx.save();
                ctx.rotate(angle);
                ctx.beginPath();
                ctx.moveTo(0, -30);
                ctx.lineTo(-5, -40);
                ctx.lineTo(5, -40);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }
        
        ctx.restore();
        
        // === YEUX EXPRESSIFS ===
        const eyeBlink = Math.floor(characterAnimationFrame / 100) % 60 === 0 ? 2 : 0;
        const eyeY = centerY - 85 + floatOffset + headBob;
        const pupilX = Math.sin(characterAnimationFrame * 0.02) * 2;
        
        ctx.save();
        ctx.translate(centerX, eyeY);
        
        if (eyeBlink === 0) {
            // Blanc des yeux
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(-10, 0, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(10, 0, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Pupilles
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-10 + pupilX, 0, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(10 + pupilX, 0, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Reflets
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(-11 + pupilX, -1, 1.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(9 + pupilX, -1, 1.5, 0, Math.PI * 2);
            ctx.fill();
        } else {
            // Yeux ferm√©s (arc)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            ctx.arc(-10, 0, 6, 0, Math.PI);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(10, 0, 6, 0, Math.PI);
            ctx.stroke();
        }
        ctx.restore();
        
        // === BOUCHE EXPRESSIVE ===
        const mouthMovement = Math.sin(characterAnimationFrame * 0.06) * 1.5;
        const mouthY = centerY - 75 + floatOffset + headBob;
        
        ctx.save();
        ctx.translate(centerX, mouthY);
        ctx.strokeStyle = '#000000';
        ctx.fillStyle = '#FF6B9D';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        
        if (choiceRatio > 0.7) {
            // Grand sourire avec dents
            ctx.beginPath();
            ctx.arc(0, 0, 10, 0, Math.PI);
            ctx.stroke();
            // Dents
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(-8, 0, 16, 5);
            ctx.strokeRect(-8, 0, 16, 5);
        } else if (choiceRatio > 0.3) {
            // Neutre/s√©rieux
            ctx.beginPath();
            ctx.moveTo(-10, 5 + mouthMovement);
            ctx.lineTo(10, 5 + mouthMovement);
            ctx.stroke();
        } else {
            // Tr√®s triste
            ctx.beginPath();
            ctx.arc(0, 10, 10, Math.PI, 0);
            ctx.stroke();
            // Larmes
            ctx.fillStyle = '#00CCFF';
            ctx.beginPath();
            ctx.arc(-15, 0, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(15, 0, 2, 0, Math.PI * 2);
            ctx.fill();
        }
        ctx.restore();
        
        // === SYST√àME DE PARTICULES AVANC√â ===
        // G√©n√©rer particules selon l'√©tat (limit√©)
        if (characterParticles.length < MAX_PARTICLES && autonomyRatio > 0.5 && Math.random() > 0.85) {
            characterParticles.push({
                x: centerX + (Math.random() - 0.5) * 120,
                y: canvas.height - 20,
                vx: (Math.random() - 0.5) * 3,
                vy: -3 - Math.random() * 3,
                life: 1,
                size: 2 + Math.random() * 4,
                type: autonomyRatio > 0.8 ? 'star' : 'circle',
                color: autonomyRatio > 0.8 ? '#00ff66' : '#00ccff',
                rotation: Math.random() * Math.PI * 2
            });
        }
        
        // Particules d'√©cologie
        if (characterParticles.length < MAX_PARTICLES && ecologyRatio > 0.6 && Math.random() > 0.92) {
            characterParticles.push({
                x: centerX + (Math.random() - 0.5) * 150,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 1,
                vy: -1 - Math.random() * 1,
                life: 1,
                size: 3 + Math.random() * 3,
                type: 'leaf',
                color: '#00ff66',
                rotation: Math.random() * Math.PI * 2,
                rotationSpeed: (Math.random() - 0.5) * 0.2
            });
        }
        
        // Particules de corruption
        const goliatCount = choicesHistory.filter(c => c.type === 'goliath').length;
        if (characterParticles.length < MAX_PARTICLES && goliatCount > 2 && Math.random() > 0.94) {
            characterParticles.push({
                x: centerX + (Math.random() - 0.5) * 100,
                y: Math.random() * 50,
                vx: (Math.random() - 0.5) * 2,
                vy: 2 + Math.random() * 2,
                life: 1,
                size: 3 + Math.random() * 3,
                type: 'smoke',
                color: '#ff3333',
                rotation: 0
            });
        }
        
        // Dessiner et animer les particules
        characterParticles = characterParticles.filter(p => {
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.015;
            if (p.rotationSpeed) p.rotation += p.rotationSpeed;
            
            if (p.life > 0) {
                ctx.save();
                ctx.globalAlpha = p.life;
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation);
                
                ctx.fillStyle = p.color;
                if (p.type === 'star') {
                    // √âtoile simplifi√©e (juste un carr√© tourn√©)
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                } else {
                    // Cercle simple pour tous les autres
                    ctx.beginPath();
                    ctx.arc(0, 0, p.size, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
                return true;
            }
            return false;
        });
        
        // === ANNEAUX D'√âNERGIE ROTATIFS ===
        if (energyRings.length < MAX_RINGS && autonomyRatio > 0.5) {
            // Cr√©er nouveaux anneaux
            if (characterAnimationFrame % 90 === 0) {
                energyRings.push({
                    radius: 40,
                    maxRadius: 120,
                    life: 1,
                    color: autonomyRatio > 0.8 ? '#00ff66' : '#00ccff',
                    speed: 0.8
                });
            }
        }
        
        // Dessiner et animer les anneaux
        energyRings = energyRings.filter(ring => {
            ring.radius += ring.speed;
            ring.life = 1 - (ring.radius / ring.maxRadius);
            
            if (ring.life > 0) {
                ctx.save();
                ctx.translate(centerX, centerY + floatOffset);
                ctx.strokeStyle = ring.color;
                ctx.globalAlpha = ring.life * 0.6;
                ctx.lineWidth = 4;
                ctx.shadowColor = ring.color;
                ctx.shadowBlur = 15;
                ctx.beginPath();
                ctx.arc(0, 0, ring.radius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
                return true;
            }
            return false;
        });
        
        // Aura principale pulsante (simplifi√©e)
        if (characterAnimationFrame % 2 === 0 && (autonomyRatio > 0.6 || ecologyRatio > 0.6)) {
            const mainAuraPulse = Math.sin(characterAnimationFrame * 0.08) * 10 + 75;
            const mainAuraOpacity = Math.sin(characterAnimationFrame * 0.08) * 0.2 + 0.4;
            const auraColor = autonomyRatio > ecologyRatio ? '#00ccff' : '#00ff66';
            
            ctx.save();
            ctx.translate(centerX, centerY + floatOffset);
            ctx.strokeStyle = auraColor;
            ctx.globalAlpha = mainAuraOpacity;
            ctx.lineWidth = 4;
            
            // Anneau simple
            ctx.beginPath();
            ctx.arc(0, 0, mainAuraPulse, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.restore();
        }
        
        // === EFFET DE CORRUPTION DRAMATIQUE ===
        if (goliatCount > 0) {
            const corruptionLevel = Math.min(goliatCount / 7, 1);
            const corruptionPulse = Math.sin(characterAnimationFrame * 0.15) * 0.15 + 0.3;
            const corruptionIntensity = corruptionLevel * corruptionPulse;
            
            // Voile rouge pulsant
            const redGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, canvas.width);
            redGradient.addColorStop(0, `rgba(255, 51, 51, ${corruptionIntensity * 0.3})`);
            redGradient.addColorStop(0.5, `rgba(255, 51, 51, ${corruptionIntensity * 0.5})`);
            redGradient.addColorStop(1, `rgba(139, 0, 0, ${corruptionIntensity * 0.4})`);
            ctx.fillStyle = redGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // √âclairs rouges pour forte corruption (r√©duits)
            if (goliatCount >= 4 && characterAnimationFrame % 120 === 0 && Math.random() > 0.7) {
                ctx.strokeStyle = 'rgba(255, 51, 51, 0.9)';
                ctx.lineWidth = 3;
                ctx.shadowColor = '#ff3333';
                ctx.shadowBlur = 20;
                const x1 = Math.random() * canvas.width;
                const y1 = 0;
                const x2 = x1 + (Math.random() - 0.5) * 100;
                const y2 = canvas.height;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo((x1 + x2) / 2 + (Math.random() - 0.5) * 50, canvas.height / 2);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
            
            // Cha√Ænes de corruption pour niveau √©lev√©
            if (goliatCount >= 6) {
                ctx.strokeStyle = 'rgba(139, 0, 0, 0.6)';
                ctx.lineWidth = 4;
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.moveTo(Math.random() * canvas.width, 0);
                    ctx.lineTo(centerX + (Math.random() - 0.5) * 50, centerY + floatOffset);
                    ctx.stroke();
                }
            }
        }
        
        // === BADGES D'√âTAT SIMPLIFI√âS ===
        // Afficher seulement tous les 3 frames pour performance
        if (characterAnimationFrame % 3 === 0) {
            const badgeY = canvas.height - 25;
            ctx.font = 'bold 11px Arial';
            ctx.textAlign = 'left';
            
            // Badge autonomie simplifi√©
            if (autonomie >= 80) {
                ctx.fillStyle = '#00ff66';
                ctx.fillText('ü¶Ö LIBRE', 10, badgeY);
            } else if (autonomie < 20) {
                ctx.fillStyle = '#ff3333';
                ctx.fillText('‚õìÔ∏è D√âPEND', 10, badgeY);
            }
            
            // Badge √©cologie simplifi√©
            if (ecologie >= 80) {
                ctx.fillStyle = '#00ff66';
                ctx.fillText('üåç VERT', canvas.width - 70, badgeY);
            } else if (ecologie < 40) {
                ctx.fillStyle = '#ff3333';
                ctx.fillText('üí® POLLU√â', canvas.width - 75, badgeY);
            }
            
            // Badge de corruption
            if (goliatCount >= 5) {
                ctx.textAlign = 'center';
                ctx.fillStyle = '#ff3333';
                ctx.fillText('‚ö†Ô∏è CORROMPU', canvas.width / 2, 15);
            }
            
            ctx.textAlign = 'left';
        }
        
        // Mise √† jour du statut avec animation de compteur
        const displayedAutonomy = document.getElementById('char-autonomy');
        const displayedEcology = document.getElementById('char-ecology');
        displayedAutonomy.textContent = Math.round(autonomie);
        displayedEcology.textContent = Math.round(ecologie);
        
        // Continuer l'animation
        requestAnimationFrame(drawCharacter);
    }
    
    // Fonctions d'animation du personnage d√©sactiv√©es

    function drawRoundRect(ctx, x, y, width, height, radius) {
        ctx.beginPath();
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + width - radius, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
        ctx.lineTo(x + width, y + height - radius);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        ctx.lineTo(x + radius, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
    }

    function getCharacterColor() {
        const autonomyRatio = autonomie / 100;
        const ecologyRatio = ecologie / 100;
        const avgScore = (autonomyRatio + ecologyRatio) / 2;
        
        if (avgScore > 0.75) {
            return '#00ff66'; // Vert: Bien √©quilibr√©
        } else if (avgScore > 0.5) {
            return '#00ccff'; // Bleu: √âquilibr√©
        } else if (avgScore > 0.25) {
            return '#ffff00'; // Jaune: Risqu√©
        } else {
            return '#ff3333'; // Rouge: En danger
        }
    }

    function getCharacterGlow() {
        const autonomyRatio = autonomie / 100;
        const ecologyRatio = ecologie / 100;
        const avgScore = (autonomyRatio + ecologyRatio) / 2;
        
        if (avgScore > 0.75) {
            return 'rgba(0, 255, 102, 0.8)';
        } else if (avgScore > 0.5) {
            return 'rgba(0, 204, 255, 0.8)';
        } else if (avgScore > 0.25) {
            return 'rgba(255, 255, 0, 0.8)';
        } else {
            return 'rgba(255, 51, 51, 0.8)';
        }
    }
    
    function lightenColor(color, percent) {
        const num = parseInt(color.replace('#', ''), 16);
        const amt = Math.round(2.55 * percent);
        const R = Math.min(255, (num >> 16) + amt);
        const G = Math.min(255, (num >> 8 & 0x00FF) + amt);
        const B = Math.min(255, (num & 0x0000FF) + amt);
        return `rgb(${R}, ${G}, ${B})`;
    }
    
    function darkenColor(color, percent) {
        const num = parseInt(color.replace('#', ''), 16);
        const amt = Math.round(2.55 * percent);
        const R = Math.max(0, (num >> 16) - amt);
        const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
        const B = Math.max(0, (num & 0x0000FF) - amt);
        return `rgb(${R}, ${G}, ${B})`;
    }
    
    function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
        let rot = Math.PI / 2 * 3;
        let x = cx;
        let y = cy;
        const step = Math.PI / spikes;
        
        ctx.beginPath();
        ctx.moveTo(cx, cy - outerRadius);
        for (let i = 0; i < spikes; i++) {
            x = cx + Math.cos(rot) * outerRadius;
            y = cy + Math.sin(rot) * outerRadius;
            ctx.lineTo(x, y);
            rot += step;
            
            x = cx + Math.cos(rot) * innerRadius;
            y = cy + Math.sin(rot) * innerRadius;
            ctx.lineTo(x, y);
            rot += step;
        }
        ctx.lineTo(cx, cy - outerRadius);
        ctx.closePath();
        ctx.fill();
    }

    // --- MOTEUR DE JEU ---
    function switchView(viewName) {
        document.getElementById('game-view').classList.add('hidden');
        document.getElementById('shop-view').classList.add('hidden');
        if(viewName === 'game') {
            document.getElementById('game-view').classList.remove('hidden');
            renderTour(); 
        } else {
            document.getElementById('shop-view').classList.remove('hidden');
            renderShop(); 
        }
    }

    function updateHeader() {
        document.getElementById("header-budget").innerText = `‚Ç¨ ${parseFloat(budget).toFixed(1)}k`;
        document.getElementById("header-autonomy").innerText = `${autonomie}%`;
        document.getElementById("header-eco").innerText = `${ecologie}/100`;
        document.getElementById("header-turn").innerText = `Tour ${tour}`;
    }

    function renderShop() {
        const container = document.getElementById("shop-container");
        container.innerHTML = "";
        
        // Cr√©er le HTML pour les achievements
        let achievementsHTML = `
            <div class="col-span-full mb-6 p-5 border border-terminal-border rounded bg-terminal-bg/50">
                <h3 class="font-bold text-neon-green text-lg mb-4">üèÜ ACHIEVEMENTS</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
        `;
        
        achievements.forEach(ach => {
            const unlocked = achievementsUnlocked[ach.id];
            achievementsHTML += `
                <div class="flex items-center gap-2 p-3 rounded border ${
                    unlocked 
                        ? 'border-neon-green bg-neon-green/10' 
                        : 'border-gray-600 bg-gray-900/30 opacity-50 grayscale'
                }">
                    <span class="material-symbols-outlined text-xl">${unlocked ? ach.icon : 'lock'}</span>
                    <div class="text-xs">
                        <p class="font-bold">${ach.name}</p>
                        <p class="text-text-dark">${ach.desc}</p>
                    </div>
                </div>
            `;
        });
        
        achievementsHTML += `</div></div>`;
        container.innerHTML = achievementsHTML;
        
        // Ajouter les items du shop
        shopItems.forEach(item => {
            const affordable = item.canBuy();
            const requiresAch = item.requiresAchievement && item.requiresAchievement.length > 0;
            const unlockedByAch = isItemUnlockedByAchievement(item.id);
            const hasReachedLimit = (itemPurchases[item.id] || 0) >= item.maxPurchases;
            
            const opacity = affordable ? "opacity-100" : "opacity-50 grayscale";
            const btnText = hasReachedLimit ? 'LIMITE ATTEINTE' : (affordable ? 'ACHETER' : 'INDISPONIBLE');
            const btnClass = affordable 
                ? `bg-${item.color}/20 text-${item.color} border-${item.color} hover:bg-${item.color}/40 cursor-pointer` 
                : "bg-gray-800 text-gray-500 border-gray-700 cursor-not-allowed";
            
            // Badge pour les requirements
            let badge = '';
            if(requiresAch && !unlockedByAch) {
                const requiredAchs = item.requiresAchievement
                    .map(id => achievements.find(a => a.id === id)?.name)
                    .filter(Boolean)
                    .join(' ou ');
                badge = `<span class="absolute top-2 left-2 text-xs px-2 py-1 bg-warning/30 border border-warning text-warning rounded flex items-center gap-1" title="D√©bloquer: ${requiredAchs}"><span class="material-symbols-outlined text-sm">lock</span>BLOQU√â</span>`;
            } else if(unlockedByAch) {
                badge = `<span class="absolute top-2 left-2 text-xs px-2 py-1 bg-neon-green/30 border border-neon-green text-neon-green rounded flex items-center gap-1"><span class="material-symbols-outlined text-sm">verified</span>D√âBLOQU√â</span>`;
            }
            
            // Compteur d'achats
            const purchaseCount = itemPurchases[item.id] || 0;
            const counterDisplay = `<span class="text-xs text-text-dark">${purchaseCount}/${item.maxPurchases}</span>`;
            
            container.innerHTML += `
                <div class="flex flex-col bg-terminal-bg border border-terminal-border p-5 rounded ${opacity} transition-all relative">
                    ${badge}
                    <div class="flex justify-between items-start mb-4">
                        <span class="material-symbols-outlined text-3xl text-${item.color}">${item.icon}</span>
                        <div class="flex flex-col items-end gap-1">
                            <span class="text-xs font-bold border border-${item.color} text-${item.color} px-2 py-1 rounded">${item.costDesc}</span>
                            ${counterDisplay}
                        </div>
                    </div>
                    <h3 class="font-bold text-white text-lg">${item.name}</h3>
                    <p class="text-xs text-text-dark mt-1 mb-4">${item.desc}</p>
                    <div class="text-sm font-semibold text-${item.color} mb-4">Effet: ${item.effectDesc}</div>
                    <button onclick="buyItem('${item.id}')" ${!affordable ? 'disabled' : ''} class="w-full py-2 border rounded font-bold uppercase text-sm ${btnClass}">
                        ${btnText}
                    </button>
                </div>
            `;
        });
        
        updateHeader();
    }

    function buyItem(id) {
        const item = shopItems.find(i => i.id === id);
        if(item && item.canBuy()) {
            const msg = item.buy();
            checkAchievements(); // V√©rifier les achievements apr√®s l'achat
            alert(`TRANSACTION R√âUSSIE : ${msg}`); 
            renderShop(); 
            const feedback = document.getElementById("feedback-area");
            feedback.innerHTML = `> ACHAT : ${item.name}<br>${msg}`;
            feedback.classList.remove("hidden");
            addBotMessage(`Ah super, tu as achet√© "${item.name}". √áa va s√ªrement faire exploser le micro-ondes.`);
        }
    }

    function renderTour() {
        const currentData = scenarios[tour];
        const container = document.getElementById("choices-container");
        container.innerHTML = "";
        
        if (!currentData) {
            renderEndScreen();
            return;
        }

        document.getElementById("scenario-title").innerText = currentData.title;
        document.getElementById("scenario-desc").innerText = currentData.desc;

        currentData.options.forEach((opt, index) => {
            // V√©rifier si le choix est bloqu√© ou d√©bloqu√©
            const choiceKey = `${tour}_${index}`;
            const blockedInfo = blockedChoices[choiceKey];
            const isBlocked = blockedInfo && blockedInfo.blocked;
            const blockReason = isBlocked ? blockReasons[choiceKey] || blockedInfo.reason : "";
            const isUnlocked = !opt.requiresUnlock || unlockedChoices[choiceKey];
            const unlockReason = opt.unlockReason || "Pr√©requis non remplis";
            
            // D√©terminer l'√©tat du choix
            const canSelect = !isBlocked && isUnlocked;
            
            const isGoliath = opt.type === "goliath";
            const color = isGoliath ? "neon-red" : "neon-green";
            
            // Styles pour choix bloqu√©s
            const cardOpacity = isBlocked || !isUnlocked ? "opacity-50 grayscale" : "";
            
            // Badge bloqu√© avec raison
            const blockedBadge = isBlocked 
                ? `<span class="absolute top-2 left-2 text-xs px-2 py-1 bg-text-dark/50 border border-text-dark text-white rounded flex items-center gap-1" title="${blockReason}"><span class="material-symbols-outlined text-sm">lock</span>BLOQU√â</span>` 
                : '';
            
            // Badge d√©bloqu√© avec raison
            const unlockedBadge = opt.requiresUnlock && unlockedChoices[choiceKey] 
                ? `<span class="absolute top-2 left-2 text-xs px-2 py-1 bg-neon-blue/30 border border-neon-blue text-neon-blue rounded" title="${opt.unlockReason || 'D√©bloqu√© par choix pr√©c√©dent'}">D√âBLOQU√â</span>` 
                : '';
            
            // Badge verrouill√© avec raison
            const lockedBadge = opt.requiresUnlock && !isUnlocked
                ? `<span class="absolute top-2 left-2 text-xs px-2 py-1 bg-text-dark/50 border border-text-dark text-white rounded flex items-center gap-1" title="${unlockReason}"><span class="material-symbols-outlined text-sm">lock</span>VERROUILL√â</span>`
                : '';
            
            // Message de raison sous la description
            const reasonMessage = isBlocked 
                ? `<p class="text-xs text-text-dark mt-2 italic">‚ö†Ô∏è ${blockReason}</p>` 
                : !isUnlocked 
                ? `<p class="text-xs text-text-dark mt-2 italic">üîí ${unlockReason}</p>`
                : '';
            
            // Bouton d√©sactiv√© si bloqu√©
            const buttonDisabled = !canSelect ? 'disabled' : '';
            const buttonClass = !canSelect 
                ? 'bg-gray-800 text-gray-500 border-gray-700 cursor-not-allowed'
                : `bg-${color}/10 text-${color} hover:bg-${color} hover:text-black border-${color}`;
            const buttonText = isBlocked ? 'BLOQU√â' : !isUnlocked ? 'VERROUILL√â' : 'EX√âCUTER';
            
            const card = `
            <div class="flex flex-col bg-black/50 border-2 border-${isBlocked || !isUnlocked ? 'gray-700' : color} ${isBlocked || !isUnlocked ? 'shadow-none' : `shadow-glitch-${isGoliath?'red':'green'}`} glitch-border ${canSelect ? 'hover:scale-[1.01]' : ''} transition-all ${cardOpacity}">
                <div class="p-6 relative">
                    ${blockedBadge}${unlockedBadge}${lockedBadge}
                    <span class="material-symbols-outlined text-4xl text-${color} absolute top-4 right-4">${opt.icon}</span>
                    <h3 class="text-xl font-bold text-${color}">${opt.title}</h3>
                    <p class="text-sm text-text-dark mt-2">${opt.desc}</p>
                    ${reasonMessage}
                </div>
                <div class="border-t border-${color}/50 p-4 space-y-2 text-sm">
                    ${opt.stats.map(s => `<div class="flex justify-between"><span class="text-text-dark">${s.l}</span><span class="${s.c}">${s.v}</span></div>`).join('')}
                </div>
                <div class="p-4 mt-auto">
                    <button onclick="choisir(${index})" ${buttonDisabled} class="w-full ${buttonClass} font-bold py-3 border transition-colors">
                        ${buttonText}
                    </button>
                </div>
            </div>`;
            container.innerHTML += card;
        });
        updateHeader();
    }

    function choisir(index) {
        const choice = scenarios[tour].options[index];
        const scenarioData = scenarios[tour];
        
        // V√©rifier si le choix est bloqu√©
        const choiceKey = `${tour}_${index}`;
        const blockedInfo = blockedChoices[choiceKey];
        const isBlocked = blockedInfo && blockedInfo.blocked;
        const isUnlocked = !choice.requiresUnlock || unlockedChoices[choiceKey];
        
        // Emp√™cher la s√©lection si bloqu√© ou non d√©bloqu√©
        if (isBlocked || !isUnlocked) {
            return;
        }
        
        // Enregistrer le choix
        choicesHistory.push({
            tour: tour,
            scenarioTitle: scenarioData.title,
            choiceTitle: choice.title,
            choiceType: choice.type,
            type: choice.type, // Ajouter type pour compatibility avec achievements
            isGood: choice.type !== 'goliath' // Tout sauf Goliath = bon choix (david, nird, etc.)
        });
        
        // === ANIMATIONS 2D SELON LE CHOIX ===
        playChoiceAnimation(choice, index);
        
        choice.effect();
        checkAchievements(); // V√©rifier les achievements apr√®s chaque choix
        
        // G√©rer les corr√©lations (d√©blocages et blocages)
        if (choice.unlocks) {
            choice.unlocks.forEach(unlock => {
                unlockedChoices[unlock] = true;
            });
        }
        if (choice.blocks) {
            choice.blocks.forEach(block => {
                blockedChoices[block] = {
                    blocked: true,
                    reason: choice.blockReason || "Choix pr√©c√©dent incompatible"
                };
                // Raison dynamique : mention du choix du joueur
                blockReasons[block] = `Vous avez choisi "${choice.title}" qui rend cette option incompatible`;
            });
        }
        
        // V√©rifier si un √©v√©nement al√©atoire se d√©clenche
        const randomEvent = triggerRandomEvent();
        if (randomEvent) {
            showRandomEvent(randomEvent);
        }
        
        tour++;
        document.getElementById("choices-container").innerHTML = `<div class="col-span-2 text-center text-neon-blue animate-pulse">TRAITEMENT DES DONN√âES...</div>`;
        setTimeout(() => {
            renderTour();
            // Ne masquer le feedback que si ce n'est pas un √©v√©nement al√©atoire
            if (!randomEvent) {
                document.getElementById("feedback-area").classList.add("hidden");
            }
        }, 600);
    }

    // --- AFFICHAGE DES √âV√âNEMENTS AL√âATOIRES ---
    function showRandomEvent(event) {
        // Appliquer les effets
        budget += event.effects.budget;
        autonomie += event.effects.autonomie;
        ecologie += event.effects.ecologie;
        
        // S'assurer que les valeurs restent dans les limites
        budget = Math.max(0, budget);
        autonomie = Math.max(0, Math.min(100, autonomie));
        ecologie = Math.max(0, Math.min(100, ecologie));
        
        updateHeader();
        
        // Afficher la notification
        const feedback = document.getElementById("feedback-area");
        const effectsText = [];
        if (event.effects.budget !== 0) effectsText.push(`Budget ${event.effects.budget > 0 ? '+' : ''}${event.effects.budget}k‚Ç¨`);
        if (event.effects.autonomie !== 0) effectsText.push(`Auto ${event.effects.autonomie > 0 ? '+' : ''}${event.effects.autonomie}%`);
        if (event.effects.ecologie !== 0) effectsText.push(`√âco ${event.effects.ecologie > 0 ? '+' : ''}${event.effects.ecologie}`);
        
        feedback.innerHTML = `
            <div class="flex items-start gap-3">
                <span class="material-symbols-outlined text-3xl text-${event.color}">${event.icon}</span>
                <div class="flex-1">
                    <div class="font-bold text-${event.color} text-lg">${event.title}</div>
                    <div class="text-white text-sm mt-1">${event.desc}</div>
                    <div class="text-text-dark text-xs mt-2">${event.message}</div>
                    <div class="flex gap-2 mt-3 text-xs">
                        ${effectsText.map(e => `<span class="px-2 py-1 bg-white/5 rounded border border-terminal-border">${e}</span>`).join('')}
                    </div>
                </div>
            </div>`;
        feedback.classList.remove("hidden");
        
        // Faire vibrer l'√©cran pour attirer l'attention
        document.getElementById("game-view").style.animation = "shake 0.3s";
        setTimeout(() => {
            document.getElementById("game-view").style.animation = "";
        }, 300);
        
        // Masquer automatiquement apr√®s 8 secondes
        setTimeout(() => {
            feedback.classList.add("hidden");
        }, 8000);
    }

    // --- LOGIQUE CHATBOT TROLL ---
    function toggleChat() {
        const win = document.getElementById("chatbot-window");
        win.classList.toggle("hidden");
        win.classList.toggle("scale-100");
    }

    function addBotMessage(text) {
        const container = document.getElementById("chat-messages");
        container.innerHTML += `
            <div class="flex flex-col items-start fade-in">
                <div class="bg-terminal-border text-xs text-text-light p-2 rounded-lg rounded-tl-none max-w-[85%] border-l-2 border-neon-blue">
                    ${text}
                </div>
            </div>`;
        container.scrollTop = container.scrollHeight;
    }

    function addUserMessage(text) {
        const container = document.getElementById("chat-messages");
        container.innerHTML += `
            <div class="flex flex-col items-end fade-in">
                <div class="bg-neon-blue/20 text-xs text-white p-2 rounded-lg rounded-tr-none max-w-[85%]">
                    ${text}
                </div>
            </div>`;
        container.scrollTop = container.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById("chat-input");
        const msg = input.value.trim().toLowerCase();
        if (!msg) return;

        addUserMessage(input.value);
        input.value = "";

        // LISTE DES GROSSES CONNERIES
        const nonsenseAnswers = [
            "J'ai demand√© √† mon chat, il a dit 'Miaou'. √áa t'aide ?",
            "Erreur 418 : Je suis une th√©i√®re.",
            "Tu as essay√© de souffler dans la cartouche ?",
            "Mon horoscope dit que tu devrais arr√™ter de cliquer partout.",
            "C'est pas faux.",
            "42. Mais je ne connais pas la question.",
            "Attends, je suis en train de t√©l√©charger de la RAM.",
            "Tu devrais installer Windows 95, c'√©tait le bon temps.",
            "Je ne suis pas pay√© pour √ßa. En fait, je ne suis pas pay√© du tout.",
            "Il para√Æt que si tu cries tr√®s fort 'LIBREOFFICE', √ßa marche mieux.",
            "Je crois que le probl√®me vient de l'interface chaise-clavier.",
            "As-tu pens√© √† √©lever des ch√®vres dans le Larzac ?",
            "D√©sol√©, je regarde une vid√©o de chatons sur le Dark Web."
        ];

        // D√©lai de r√©ponse simul√©
        setTimeout(() => {
            let response = "";

            // TROLLING CIBL√â SUR MOTS CL√âS
            if (msg.includes("aide") || msg.includes("help") || msg.includes("bonjour")) {
                response = "De l'aide ? T'as cru que j'√©tais Clippy ? D√©brouille-toi.";
            } else if (msg.includes("conseil") || msg.includes("quoi faire")) {
                response = "Mon conseil : appuie sur Alt+F4 pour gagner instantan√©ment.";
            } else if (msg.includes("budget") || msg.includes("argent") || msg.includes("sous")) {
                response = "Le budget ? On s'en fiche, imprime des billets Monopoly.";
            } else if (msg.includes("linux") || msg.includes("libre")) {
                response = "Linux ? C'est pas une marque de d√©tergent pour le sol ?";
            } else if (msg.includes("gafam") || msg.includes("microsoft") || msg.includes("google")) {
                response = "Eux au moins, ils ont des cookies. J'aime les cookies.";
            } else if (msg.includes("score") || msg.includes("gagner")) {
                response = "Le seul moyen de gagner, c'est de ne pas jouer. C'est profond, hein ?";
            } else {
                // R√âPONSE AU HASARD SI PAS DE MOT CL√â
                const random = Math.floor(Math.random() * nonsenseAnswers.length);
                response = nonsenseAnswers[random];
            }

            addBotMessage(response);
        }, 600);
    }

    // Initialisation
    renderTour();

    // --- √âCRAN DE FIN AVEC R√âCAPITULATIF ---
    function renderEndScreen() {
        document.getElementById("scenario-title").innerText = "SIMULATION TERMIN√âE";
        document.getElementById("scenario-desc").innerText = `> Score Final: Budget ${budget}k | Auto ${autonomie}% | √âco ${ecologie}`;
        
        const goodChoices = choicesHistory.filter(c => c.isGood).length;
        const badChoices = choicesHistory.filter(c => !c.isGood).length;
        const totalChoices = choicesHistory.length;
        const goodPercent = Math.round((goodChoices / totalChoices) * 100);
        const badPercent = Math.round((badChoices / totalChoices) * 100);
        
        const container = document.getElementById("choices-container");
        container.innerHTML = `
            <div class="col-span-2 space-y-6">
                <!-- GRAPHIQUE -->
                <div class="bg-terminal-bg/80 border-2 border-neon-blue p-6 rounded">
                    <h3 class="text-xl font-bold text-neon-blue mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined">analytics</span>
                        ANALYSE DES D√âCISIONS
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-neon-green/10 border border-neon-green p-4 rounded text-center">
                            <div class="text-4xl font-bold text-neon-green">${goodChoices}</div>
                            <div class="text-sm text-text-dark mt-1">Choix Durables</div>
                            <div class="text-xs text-neon-green mt-2">${goodPercent}%</div>
                        </div>
                        <div class="bg-neon-red/10 border border-neon-red p-4 rounded text-center">
                            <div class="text-4xl font-bold text-neon-red">${badChoices}</div>
                            <div class="text-sm text-text-dark mt-1">Choix Big Tech</div>
                            <div class="text-xs text-neon-red mt-2">${badPercent}%</div>
                        </div>
                    </div>
                    
                    <!-- BARRE DE PROGRESSION -->
                    <div class="relative h-8 bg-terminal-border rounded-full overflow-hidden">
                        <div class="absolute top-0 left-0 h-full bg-neon-green transition-all duration-1000" style="width: ${goodPercent}%"></div>
                        <div class="absolute top-0 right-0 h-full bg-neon-red transition-all duration-1000" style="width: ${badPercent}%"></div>
                    </div>
                    
                    <!-- GRAPHIQUE VISUEL -->
                    <div class="mt-6 flex justify-center items-end gap-2 h-40">
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-full bg-neon-green rounded-t transition-all duration-1000" style="height: ${goodPercent}%"></div>
                            <div class="text-xs text-neon-green mt-2 font-bold">DURABLES</div>
                        </div>
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-full bg-neon-red rounded-t transition-all duration-1000" style="height: ${badPercent}%"></div>
                            <div class="text-xs text-neon-red mt-2 font-bold">BIG TECH</div>
                        </div>
                    </div>
                </div>
                
                <!-- HISTORIQUE D√âTAILL√â -->
                <div class="bg-terminal-bg/80 border-2 border-terminal-border p-6 rounded">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined">history</span>
                        HISTORIQUE DES D√âCISIONS
                    </h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto chat-scroll">
                        ${choicesHistory.map((choice, i) => {
                            const color = choice.isGood ? 'neon-green' : 'neon-red';
                            const icon = choice.isGood ? 'check_circle' : 'cancel';
                            const label = choice.isGood ? 'DURABLE' : 'BIG TECH';
                            return `
                            <div class="flex items-start gap-3 p-3 bg-black/50 border-l-4 border-${color} rounded">
                                <span class="material-symbols-outlined text-${color} text-2xl">${icon}</span>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold text-text-dark">TOUR ${choice.tour}</span>
                                        <span class="text-xs px-2 py-0.5 rounded bg-${color}/20 text-${color} border border-${color}/50">${label}</span>
                                    </div>
                                    <div class="text-sm text-white font-semibold">${choice.scenarioTitle}</div>
                                    <div class="text-xs text-text-dark mt-1">‚ûú ${choice.choiceTitle}</div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                
                <!-- ACTIONS -->
                <div class="flex gap-4">
                    <button onclick="location.reload()" class="flex-1 bg-neon-blue/20 text-neon-blue border border-neon-blue py-3 rounded hover:bg-neon-blue hover:text-black font-bold transition-colors">
                        <span class="material-symbols-outlined text-lg align-middle mr-2">refresh</span>
                        RECOMMENCER
                    </button>
                    <button onclick="window.location.href='index.html'" class="flex-1 bg-terminal-border text-white border border-terminal-border py-3 rounded hover:bg-white/10 font-bold transition-colors">
                        <span class="material-symbols-outlined text-lg align-middle mr-2">home</span>
                        ACCUEIL
                    </button>
                </div>
            </div>
        `;
    }

    // --- VISUALISEUR AUDIO ---
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let systemAudio = null;
    let dataArray = null;
    let bufferLength = 0;
    let isMicActive = false;
    let isSystemActive = false;
    const canvas = document.getElementById('audio-visualizer');
    const canvasCtx = canvas.getContext('2d');

    // Demander les autorisations automatiquement au chargement
    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            // Demander automatiquement l'acc√®s au micro
            startMic();
        }, 500);
    });

    async function startMic() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
            
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            
            isMicActive = true;
            document.getElementById('mic-toggle').classList.add('text-neon-green');
            document.getElementById('mic-toggle').classList.remove('text-text-dark');
            
            updateAudioInfo();
            draw();
        } catch (err) {
            console.error('Erreur microphone:', err);
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                document.getElementById('audio-info').textContent = 'Micro : autorisation refus√©e';
            } else if (err.name === 'NotFoundError') {
                document.getElementById('audio-info').textContent = 'Aucun micro d√©tect√©';
            } else {
                document.getElementById('audio-info').textContent = 'Erreur micro';
            }
        }
    }

    async function startSystemAudio() {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ 
                video: true,
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                }
            });
            
            // Arr√™ter la vid√©o imm√©diatement (on ne veut que l'audio)
            stream.getVideoTracks().forEach(track => track.stop());
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
            
            const audioTracks = stream.getAudioTracks();
            if (audioTracks.length > 0) {
                systemAudio = audioContext.createMediaStreamSource(stream);
                systemAudio.connect(analyser);
                
                isSystemActive = true;
                document.getElementById('system-toggle').classList.add('text-neon-green');
                document.getElementById('system-toggle').classList.remove('text-text-dark');
                
                updateAudioInfo();
                draw();
            } else {
                document.getElementById('audio-info').textContent = 'Aucun audio syst√®me partag√©';
            }
        } catch (err) {
            console.error('Erreur audio syst√®me:', err);
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                document.getElementById('audio-info').textContent = 'Partage audio refus√©';
            } else {
                document.getElementById('audio-info').textContent = 'Erreur audio syst√®me';
            }
        }
    }

    function toggleMic() {
        if (isMicActive) {
            stopMic();
        } else {
            startMic();
        }
    }

    function toggleSystemAudio() {
        if (isSystemActive) {
            stopSystemAudio();
        } else {
            startSystemAudio();
        }
    }

    function stopMic() {
        if (microphone) {
            microphone.disconnect();
            microphone = null;
        }
        isMicActive = false;
        document.getElementById('mic-toggle').classList.remove('text-neon-green');
        document.getElementById('mic-toggle').classList.add('text-text-dark');
        updateAudioInfo();
        checkIfShouldStop();
    }

    function stopSystemAudio() {
        if (systemAudio) {
            systemAudio.disconnect();
            systemAudio = null;
        }
        isSystemActive = false;
        document.getElementById('system-toggle').classList.remove('text-neon-green');
        document.getElementById('system-toggle').classList.add('text-text-dark');
        updateAudioInfo();
        checkIfShouldStop();
    }

    function checkIfShouldStop() {
        if (!isMicActive && !isSystemActive) {
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                analyser = null;
            }
            // Effacer le canvas
            canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        }
    }

    function updateAudioInfo() {
        const info = document.getElementById('audio-info');
        if (isMicActive && isSystemActive) {
            info.textContent = 'Micro + Syst√®me actifs';
        } else if (isMicActive) {
            info.textContent = 'Micro actif';
        } else if (isSystemActive) {
            info.textContent = 'Syst√®me actif';
        } else {
            info.textContent = 'Audio d√©sactiv√©';
        }
    }

    function draw() {
        if (!isMicActive && !isSystemActive) return;
        
        requestAnimationFrame(draw);
        
        analyser.getByteFrequencyData(dataArray);
        
        // Fond avec effet de tra√Æn√©e
        canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        
        const barWidth = (canvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;
        
        for (let i = 0; i < bufferLength; i++) {
            barHeight = (dataArray[i] / 255) * canvas.height * 0.8;
            
            // Gradient de couleur selon la fr√©quence
            const hue = (i / bufferLength) * 180 + 180; // De cyan √† vert
            canvasCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            
            // Dessiner la barre depuis le bas
            canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            
            // Effet de reflet en haut
            canvasCtx.globalAlpha = 0.3;
            canvasCtx.fillRect(x, 0, barWidth, barHeight * 0.3);
            canvasCtx.globalAlpha = 1.0;
            
            x += barWidth + 1;
        }
    }
</script>
</body>
</html>