<!DOCTYPE html>
<html class="dark" lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Décisions (NIRD/Obsolescence/Big Tech)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script src="data.js"></script>
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#c81e1e",
                        "secondary": "#166534",
                        "terminal-bg": "#121212",
                        "terminal-border": "#333333",
                        "neon-red": "#ff3333",
                        "neon-green": "#00ff66",
                        "neon-blue": "#00ccff",
                        "text-light": "#e0e0e0",
                        "text-dark": "#a0a0a0",
                        "success": "#00ff66",
                        "danger": "#ff3333",
                        "warning": "#ffff00",
                    },
                    fontFamily: {
                        "mono": ["'Roboto Mono'", "monospace"],
                    },
                    boxShadow: {
                        'glitch-red': '3px 3px 0px 0px #ff3333, -3px -3px 0px 0px #333333',
                        'glitch-green': '3px 3px 0px 0px #00ff66, -3px -3px 0px 0px #333333',
                        'glitch-blue': '3px 3px 0px 0px #00ccff, -3px -3px 0px 0px #333333',
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        .glitch-border { clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%); }
        .text-shadow-neon { text-shadow: 0 0 5px currentColor; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: #121212; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .chat-scroll::-webkit-scrollbar-thumb:hover { background: #00ccff; }
    </style>
</head>

<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Navigation - Village Numérique Résistant</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#c81e1e",
                        "secondary": "#166534",
                        "terminal-bg": "#121212",
                        "terminal-border": "#333333",
                        "neon-red": "#ff3333",
                        "neon-green": "#00ff66",
                        "neon-blue": "#00ccff",
                        "text-light": "#e0e0e0",
                        "text-dark": "#a0a0a0",
                        "warning": "#ffff00",
                    },
                    fontFamily: {
                        "mono": ["'Roboto Mono'", "monospace"],
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { 
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; 
            vertical-align: middle; 
        }
        
        .navbar-link {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .navbar-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #00ff66, #00ccff);
            transition: width 0.3s ease;
        }
        
        .navbar-link:hover::after,
        .navbar-link.active::after {
            width: 100%;
        }
        
        .navbar-link.active {
            color: #00ff66;
        }
        
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        .glitch-text {
            animation: glitch 3s infinite;
        }
        
        @keyframes glitch {
            0%, 90%, 100% { 
                text-shadow: 1px 0 #ff3333, -1px 0 #00ccff; 
            }
            95% { 
                text-shadow: -1px 0 #ff3333, 1px 0 #00ccff; 
                transform: skewX(5deg); 
            }
            96% { 
                text-shadow: 1px 0 #ff3333, -1px 0 #00ccff; 
                transform: skewX(0deg); 
            }
        }
    </style>
</head>
<body class="bg-black font-mono text-text-light">

<!-- NAVBAR PRINCIPALE -->
<nav class="bg-black border-b-2 border-terminal-border sticky top-0 z-50 backdrop-blur-sm bg-black/95">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            
            <!-- LOGO -->
            <div class="flex items-center gap-3">
                <a href="index.html" class="flex items-center gap-2 group">
                    <span class="material-symbols-outlined text-3xl text-neon-green group-hover:text-neon-blue transition-colors">terminal</span>
                    <span class="text-xl font-bold text-white glitch-text hidden sm:inline">VNR</span>
                    <span class="text-xs text-text-dark hidden md:inline">v1.0</span>
                </a>
            </div>

            <!-- MENU DESKTOP -->
            <div class="hidden md:flex items-center gap-6">
                <a href="index.html" class="navbar-link text-text-light hover:text-neon-green flex items-center gap-2 py-2">
                    <span class="material-symbols-outlined text-lg">home</span>
                    <span class="text-sm font-medium">Accueil</span>
                </a>
                
                <a href="decision.html" class="navbar-link text-text-light hover:text-neon-green flex items-center gap-2 py-2">
                    <span class="material-symbols-outlined text-lg">dashboard</span>
                    <span class="text-sm font-medium">Décisions</span>
                </a>
                
                <a href="klub.html" class="navbar-link text-text-light hover:text-neon-green flex items-center gap-2 py-2">
                    <span class="material-symbols-outlined text-lg">celebration</span>
                    <span class="text-sm font-medium">KLUB</span>
                </a>

                <div class="h-6 w-px bg-terminal-border"></div>

                <!-- INFOS STATUS -->
                <div class="flex items-center gap-2 text-xs">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-neon-green opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-neon-green"></span>
                    </span>
                    <span class="text-neon-green font-bold">ONLINE</span>
                </div>
            </div>

            <!-- BOUTON MENU MOBILE -->
            <button onclick="toggleMobileMenu()" class="md:hidden text-neon-blue hover:text-neon-green transition-colors">
                <span class="material-symbols-outlined text-3xl" id="menu-icon">menu</span>
            </button>
        </div>
    </div>

    <!-- MENU MOBILE -->
    <div id="mobile-menu" class="mobile-menu md:hidden fixed top-16 left-0 w-64 h-screen bg-black border-r-2 border-terminal-border z-40">
        <div class="flex flex-col p-4 gap-2">
            <a href="index.html" class="navbar-link text-text-light hover:text-neon-green hover:bg-terminal-border flex items-center gap-3 p-3 rounded transition-all">
                <span class="material-symbols-outlined">home</span>
                <span class="font-medium">Accueil</span>
            </a>
            
            <a href="decision.html" class="navbar-link text-text-light hover:text-neon-green hover:bg-terminal-border flex items-center gap-3 p-3 rounded transition-all">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="font-medium">Décisions</span>
            </a>
            
            <a href="klub.html" class="navbar-link text-text-light hover:text-neon-green hover:bg-terminal-border flex items-center gap-3 p-3 rounded transition-all">
                <span class="material-symbols-outlined">celebration</span>
                <span class="font-medium">KLUB</span>
            </a>

            <div class="h-px bg-terminal-border my-2"></div>

            <div class="p-3 border border-terminal-border rounded bg-white/5">
                <p class="text-xs text-text-dark mb-2">STATUS SYSTÈME:</p>
                <div class="flex items-center gap-2 text-neon-green text-sm">
                    <span class="material-symbols-outlined text-sm">check_circle</span>
                    <span>ONLINE</span>
                </div>
                <p class="text-xs text-text-dark mt-3 mb-2">CONNEXION:</p>
                <div class="flex items-center gap-2 text-warning text-sm">
                    <span class="material-symbols-outlined text-sm">lock</span>
                    <span>SÉCURISÉE</span>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- OVERLAY POUR FERMER LE MENU MOBILE -->
<div id="overlay" class="hidden fixed inset-0 bg-black/50 z-30 md:hidden" onclick="toggleMobileMenu()"></div>

<!-- SCRIPT JAVASCRIPT -->
<script>
    // Gestion du menu mobile
    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        const overlay = document.getElementById('overlay');
        const icon = document.getElementById('menu-icon');
        
        menu.classList.toggle('open');
        overlay.classList.toggle('hidden');
        
        if (menu.classList.contains('open')) {
            icon.textContent = 'close';
        } else {
            icon.textContent = 'menu';
        }
    }

    // Fermer le menu en cliquant sur un lien
    document.querySelectorAll('#mobile-menu a').forEach(link => {
        link.addEventListener('click', () => {
            toggleMobileMenu();
        });
    });

    // Marquer la page active
    window.addEventListener('DOMContentLoaded', () => {
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('.navbar-link').forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });
    });
</script>
<body class="bg-black font-mono text-text-light">
<div class="flex h-screen w-full relative">
    
    <aside class="flex w-64 flex-col bg-black border-r border-terminal-border p-4 hidden md:flex">
        <div class="flex flex-col gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border border-terminal-border" style='background-image: url("https://ui-avatars.com/api/?name=LN&background=0D8ABC&color=fff");'></div>
                <div class="flex flex-col">
                    <h1 class="text-white text-base font-medium leading-normal">Lycée Numérique</h1>
                    <p class="text-text-dark text-sm font-normal leading-normal">// Tableau de Bord</p>
                </div>
            </div>
            <nav class="flex flex-col gap-2 mt-4">
                <button onclick="switchView('game')" class="flex w-full items-center gap-3 px-3 py-2 text-text-dark hover:bg-terminal-border hover:text-white rounded text-left focus:bg-terminal-border focus:text-white">
                    <span class="material-symbols-outlined text-2xl">dashboard</span>
                    <p class="text-sm font-medium">Décisions</p>
                </button>
                <button onclick="switchView('shop')" class="flex w-full items-center gap-3 px-3 py-2 text-neon-blue bg-neon-blue/5 border border-neon-blue/30 rounded text-left hover:bg-neon-blue/10">
                    <span class="material-symbols-outlined text-2xl !font-bold">shopping_cart</span>
                    <p class="text-sm font-medium">Achats / Bonus</p>
                </button>
                <div class="h-px bg-terminal-border my-2"></div>
                <div class="px-3 text-xs text-text-dark">INFRASTRUCTURE</div>
                <div class="flex items-center gap-3 px-3 py-1 text-text-dark">
                    <span class="material-symbols-outlined text-lg text-neon-green">check_circle</span>
                    <span class="text-xs">Serveur NIRD: ON</span>
                </div>
                
                <!-- VISUALISEUR AUDIO -->
                <div class="mt-6 mx-3 p-3 border border-neon-blue/30 bg-neon-blue/5 rounded">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-xs text-neon-blue font-bold">AUDIO SPECTRUM</div>
                        <div class="flex gap-2">
                            <button id="mic-toggle" onclick="toggleMic()" class="text-xs text-text-dark hover:text-neon-blue flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">mic</span>
                            </button>
                            <button id="system-toggle" onclick="toggleSystemAudio()" class="text-xs text-text-dark hover:text-neon-blue flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">volume_up</span>
                            </button>
                        </div>
                    </div>
                    <canvas id="audio-visualizer" width="200" height="100" class="w-full bg-black/50 rounded"></canvas>
                    <div class="text-xs text-text-dark mt-2 text-center" id="audio-info">Cliquez sur les icônes pour activer</div>
                </div>
            </nav>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen">
        <header class="flex items-center justify-between p-4 border-b border-terminal-border bg-black">
            <div class="flex flex-wrap gap-4">
                <div class="flex items-center gap-3 min-w-[158px] rounded p-3 border border-terminal-border bg-black">
                    <span class="material-symbols-outlined text-neon-green text-3xl">account_balance_wallet</span>
                    <div>
                        <p class="text-text-dark text-xs font-medium">Budget</p>
                        <p id="header-budget" class="text-white tracking-light text-xl font-bold leading-tight">€ 50,000</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 min-w-[158px] rounded p-3 border border-terminal-border bg-black">
                    <span class="material-symbols-outlined text-neon-green text-3xl">model_training</span>
                    <div>
                        <p class="text-text-dark text-xs font-medium">Autonomie</p>
                        <p id="header-autonomy" class="text-white tracking-light text-xl font-bold leading-tight">15%</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 min-w-[158px] rounded p-3 border border-terminal-border bg-black">
                    <span class="material-symbols-outlined text-neon-green text-3xl">eco</span>
                    <div>
                        <p class="text-text-dark text-xs font-medium">Écologie</p>
                        <p id="header-eco" class="text-white tracking-light text-xl font-bold leading-tight">65/100</p>
                    </div>
                </div>
            </div>
            <div class="text-right hidden sm:block">
                <p id="header-turn" class="text-white font-semibold">Tour 1</p>
                <p class="text-xs text-text-dark uppercase tracking-widest">En attente d'ordre</p>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-8 flex flex-col items-center bg-black bg-[radial-gradient(ellipse_80%_80%_at_50%_-20%,rgba(120,119,198,0.2),rgba(255,255,255,0))]">
            
            <div id="game-view" class="w-full max-w-6xl bg-terminal-bg/80 backdrop-blur-sm border-2 border-terminal-border p-8 glitch-border fade-in">
                <h1 id="scenario-title" class="text-white tracking-light text-3xl md:text-4xl font-bold leading-tight text-center">INITIALISATION...</h1>
                <p id="scenario-desc" class="text-text-dark text-base font-normal leading-normal text-center mt-4 max-w-3xl mx-auto"></p>
                <div id="feedback-area" class="hidden mt-6 p-4 bg-white/5 border-l-4 border-neon-blue text-white rounded shadow-lg max-w-3xl mx-auto"></div>
                <div id="choices-container" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8"></div>
            </div>

            <div id="shop-view" class="hidden w-full max-w-6xl fade-in">
                <div class="mb-6 flex items-center justify-between">
                    <h2 class="text-3xl font-bold text-neon-blue text-shadow-neon">MARCHÉ DES RESSOURCES</h2>
                    <button onclick="switchView('game')" class="text-sm border border-terminal-border px-4 py-2 hover:bg-white/10 rounded">RETOUR AU JEU</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="shop-container"></div>
                <div class="mt-8 p-4 border border-warning/30 bg-warning/5 rounded text-warning text-sm flex gap-3 items-start">
                    <span class="material-symbols-outlined">info</span>
                    <p>Les acquisitions prennent effet immédiatement.</p>
                </div>
            </div>

        </div>
    </main>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-4">
        
        <div id="chatbot-window" class="hidden w-80 h-96 bg-black border border-neon-blue shadow-[0_0_15px_rgba(0,204,255,0.3)] flex flex-col transition-all duration-300 transform scale-95 origin-bottom-right">
            <div class="bg-neon-blue/10 p-3 border-b border-neon-blue/30 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-neon-blue opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-neon-blue"></span>
                    </span>
                    <span class="text-neon-blue font-bold text-sm">TROLL_BOT v0.1</span>
                </div>
                <button onclick="toggleChat()" class="text-neon-blue hover:text-white"><span class="material-symbols-outlined text-lg">close</span></button>
            </div>
            
            <div id="chat-messages" class="flex-1 p-3 overflow-y-auto chat-scroll space-y-3">
                <div class="flex flex-col items-start">
                    <div class="bg-terminal-border text-xs text-text-light p-2 rounded-lg rounded-tl-none max-w-[85%]">
                        Salut humain. Je suis là pour t'ignorer. Pose une question que je rigole. Mot clé: aide, conseil, budget, linux, gafam, score...
                    </div>
                </div>
            </div>

            <div class="p-3 border-t border-terminal-border bg-black flex gap-2">
                <input id="chat-input" type="text" placeholder="Essaye de me parler..." class="flex-1 bg-terminal-bg border border-terminal-border text-white text-xs p-2 rounded focus:border-neon-blue focus:outline-none" onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="bg-neon-blue/20 text-neon-blue p-2 rounded hover:bg-neon-blue hover:text-black transition-colors">
                    <span class="material-symbols-outlined text-lg">send</span>
                </button>
            </div>
        </div>

        <button onclick="toggleChat()" class="h-14 w-14 bg-black border-2 border-neon-blue rounded-full shadow-[0_0_10px_rgba(0,204,255,0.5)] flex items-center justify-center text-neon-blue hover:bg-neon-blue hover:text-black transition-all hover:scale-110">
            <span class="material-symbols-outlined text-3xl">smart_toy</span>
        </button>
    </div>

</div>

<script>
    // --- VARIABLES D'ÉTAT ---
    let tour = 1; 

    // Lecture URL
    const urlParams = new URLSearchParams(window.location.search);
    const difficulty = urlParams.get('diff') || 'normal';
    if(difficulty === 'easy') { budget = 70; autonomie = 20; }
    if(difficulty === 'hard') { budget = 20; autonomie = 5; ecologie = 50; }

    // --- MOTEUR DE JEU ---
    function switchView(viewName) {
        document.getElementById('game-view').classList.add('hidden');
        document.getElementById('shop-view').classList.add('hidden');
        if(viewName === 'game') {
            document.getElementById('game-view').classList.remove('hidden');
            renderTour(); 
        } else {
            document.getElementById('shop-view').classList.remove('hidden');
            renderShop(); 
        }
    }

    function updateHeader() {
        document.getElementById("header-budget").innerText = `€ ${parseFloat(budget).toFixed(1)}k`;
        document.getElementById("header-autonomy").innerText = `${autonomie}%`;
        document.getElementById("header-eco").innerText = `${ecologie}/100`;
        document.getElementById("header-turn").innerText = `Tour ${tour}`;
    }

    function renderShop() {
        const container = document.getElementById("shop-container");
        container.innerHTML = "";
        shopItems.forEach(item => {
            const affordable = item.canBuy();
            const opacity = affordable ? "opacity-100" : "opacity-50 grayscale";
            const btnClass = affordable 
                ? `bg-${item.color}/20 text-${item.color} border-${item.color} hover:bg-${item.color}/40 cursor-pointer` 
                : "bg-gray-800 text-gray-500 border-gray-700 cursor-not-allowed";

            container.innerHTML += `
            <div class="flex flex-col bg-terminal-bg border border-terminal-border p-5 rounded ${opacity} transition-all">
                <div class="flex justify-between items-start mb-4">
                    <span class="material-symbols-outlined text-3xl text-${item.color}">${item.icon}</span>
                    <span class="text-xs font-bold border border-${item.color} text-${item.color} px-2 py-1 rounded">${item.costDesc}</span>
                </div>
                <h3 class="font-bold text-white text-lg">${item.name}</h3>
                <p class="text-xs text-text-dark mt-1 mb-4">${item.desc}</p>
                <div class="text-sm font-semibold text-${item.color} mb-4">Effet: ${item.effectDesc}</div>
                <button onclick="buyItem('${item.id}')" ${!affordable ? 'disabled' : ''} class="w-full py-2 border rounded font-bold uppercase text-sm ${btnClass}">
                    ${affordable ? 'ACHETER' : 'INDISPONIBLE'}
                </button>
            </div>`;
        });
        updateHeader();
    }

    function buyItem(id) {
        const item = shopItems.find(i => i.id === id);
        if(item && item.canBuy()) {
            const msg = item.buy();
            alert(`TRANSACTION RÉUSSIE : ${msg}`); 
            renderShop(); 
            const feedback = document.getElementById("feedback-area");
            feedback.innerHTML = `> ACHAT : ${item.name}<br>${msg}`;
            feedback.classList.remove("hidden");
            // Le Troll Bot commente l'achat n'importe comment
            addBotMessage(`Ah super, tu as acheté "${item.name}". Ça va sûrement faire exploser le micro-ondes.`);
        }
    }

    function renderTour() {
        const currentData = scenarios[tour];
        const container = document.getElementById("choices-container");
        container.innerHTML = "";
        
        if (!currentData) {
            document.getElementById("scenario-title").innerText = "SIMULATION TERMINÉE";
            document.getElementById("scenario-desc").innerText = `> Score Final: Budget ${budget}k | Auto ${autonomie}% | Éco ${ecologie}`;
            return;
        }

        document.getElementById("scenario-title").innerText = currentData.title;
        document.getElementById("scenario-desc").innerText = currentData.desc;

        currentData.options.forEach((opt, index) => {
            const isGoliath = opt.type === "goliath";
            const color = isGoliath ? "neon-red" : "neon-green";
            const card = `
            <div class="flex flex-col bg-black/50 border-2 border-${color} shadow-glitch-${isGoliath?'red':'green'} glitch-border hover:scale-[1.01] transition-all">
                <div class="p-6 relative">
                    <span class="material-symbols-outlined text-4xl text-${color} absolute top-4 right-4">${opt.icon}</span>
                    <h3 class="text-xl font-bold text-${color}">${opt.title}</h3>
                    <p class="text-sm text-text-dark mt-2 h-12">${opt.desc}</p>
                </div>
                <div class="border-t border-${color}/50 p-4 space-y-2 text-sm">
                    ${opt.stats.map(s => `<div class="flex justify-between"><span class="text-text-dark">${s.l}</span><span class="${s.c}">${s.v}</span></div>`).join('')}
                </div>
                <div class="p-4 mt-auto">
                    <button onclick="choisir(${index})" class="w-full bg-${color}/10 text-${color} hover:bg-${color} hover:text-black font-bold py-3 border border-${color} transition-colors">
                        EXÉCUTER
                    </button>
                </div>
            </div>`;
            container.innerHTML += card;
        });
        updateHeader();
    }

    function choisir(index) {
        const choice = scenarios[tour].options[index];
        choice.effect();
        tour++;
        document.getElementById("choices-container").innerHTML = `<div class="col-span-2 text-center text-neon-blue animate-pulse">TRAITEMENT DES DONNÉES...</div>`;
        setTimeout(() => {
            renderTour();
            document.getElementById("feedback-area").classList.add("hidden");
        }, 600);
    }

    // --- LOGIQUE CHATBOT TROLL ---
    function toggleChat() {
        const win = document.getElementById("chatbot-window");
        win.classList.toggle("hidden");
        win.classList.toggle("scale-100");
    }

    function addBotMessage(text) {
        const container = document.getElementById("chat-messages");
        container.innerHTML += `
            <div class="flex flex-col items-start fade-in">
                <div class="bg-terminal-border text-xs text-text-light p-2 rounded-lg rounded-tl-none max-w-[85%] border-l-2 border-neon-blue">
                    ${text}
                </div>
            </div>`;
        container.scrollTop = container.scrollHeight;
    }

    function addUserMessage(text) {
        const container = document.getElementById("chat-messages");
        container.innerHTML += `
            <div class="flex flex-col items-end fade-in">
                <div class="bg-neon-blue/20 text-xs text-white p-2 rounded-lg rounded-tr-none max-w-[85%]">
                    ${text}
                </div>
            </div>`;
        container.scrollTop = container.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById("chat-input");
        const msg = input.value.trim().toLowerCase();
        if (!msg) return;

        addUserMessage(input.value);
        input.value = "";

        // LISTE DES GROSSES CONNERIES
        const nonsenseAnswers = [
            "J'ai demandé à mon chat, il a dit 'Miaou'. Ça t'aide ?",
            "Erreur 418 : Je suis une théière.",
            "Tu as essayé de souffler dans la cartouche ?",
            "Mon horoscope dit que tu devrais arrêter de cliquer partout.",
            "C'est pas faux.",
            "42. Mais je ne connais pas la question.",
            "Attends, je suis en train de télécharger de la RAM.",
            "Tu devrais installer Windows 95, c'était le bon temps.",
            "Je ne suis pas payé pour ça. En fait, je ne suis pas payé du tout.",
            "Il paraît que si tu cries très fort 'LIBREOFFICE', ça marche mieux.",
            "Je crois que le problème vient de l'interface chaise-clavier.",
            "As-tu pensé à élever des chèvres dans le Larzac ?",
            "Désolé, je regarde une vidéo de chatons sur le Dark Web."
        ];

        // Délai de réponse simulé
        setTimeout(() => {
            let response = "";

            // TROLLING CIBLÉ SUR MOTS CLÉS
            if (msg.includes("aide") || msg.includes("help") || msg.includes("bonjour")) {
                response = "De l'aide ? T'as cru que j'étais Clippy ? Débrouille-toi.";
            } else if (msg.includes("conseil") || msg.includes("quoi faire")) {
                response = "Mon conseil : appuie sur Alt+F4 pour gagner instantanément.";
            } else if (msg.includes("budget") || msg.includes("argent") || msg.includes("sous")) {
                response = "Le budget ? On s'en fiche, imprime des billets Monopoly.";
            } else if (msg.includes("linux") || msg.includes("libre")) {
                response = "Linux ? C'est pas une marque de détergent pour le sol ?";
            } else if (msg.includes("gafam") || msg.includes("microsoft") || msg.includes("google")) {
                response = "Eux au moins, ils ont des cookies. J'aime les cookies.";
            } else if (msg.includes("score") || msg.includes("gagner")) {
                response = "Le seul moyen de gagner, c'est de ne pas jouer. C'est profond, hein ?";
            } else {
                // RÉPONSE AU HASARD SI PAS DE MOT CLÉ
                const random = Math.floor(Math.random() * nonsenseAnswers.length);
                response = nonsenseAnswers[random];
            }

            addBotMessage(response);
        }, 600);
    }

    // Initialisation
    renderTour();

    // --- VISUALISEUR AUDIO ---
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let systemAudio = null;
    let dataArray = null;
    let bufferLength = 0;
    let isMicActive = false;
    let isSystemActive = false;
    const canvas = document.getElementById('audio-visualizer');
    const canvasCtx = canvas.getContext('2d');

    // Demander les autorisations automatiquement au chargement
    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            // Demander automatiquement l'accès au micro
            startMic();
        }, 500);
    });

    async function startMic() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
            
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            
            isMicActive = true;
            document.getElementById('mic-toggle').classList.add('text-neon-green');
            document.getElementById('mic-toggle').classList.remove('text-text-dark');
            
            updateAudioInfo();
            draw();
        } catch (err) {
            console.error('Erreur microphone:', err);
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                document.getElementById('audio-info').textContent = 'Micro : autorisation refusée';
            } else if (err.name === 'NotFoundError') {
                document.getElementById('audio-info').textContent = 'Aucun micro détecté';
            } else {
                document.getElementById('audio-info').textContent = 'Erreur micro';
            }
        }
    }

    async function startSystemAudio() {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ 
                video: true,
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                }
            });
            
            // Arrêter la vidéo immédiatement (on ne veut que l'audio)
            stream.getVideoTracks().forEach(track => track.stop());
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
            
            const audioTracks = stream.getAudioTracks();
            if (audioTracks.length > 0) {
                systemAudio = audioContext.createMediaStreamSource(stream);
                systemAudio.connect(analyser);
                
                isSystemActive = true;
                document.getElementById('system-toggle').classList.add('text-neon-green');
                document.getElementById('system-toggle').classList.remove('text-text-dark');
                
                updateAudioInfo();
                draw();
            } else {
                document.getElementById('audio-info').textContent = 'Aucun audio système partagé';
            }
        } catch (err) {
            console.error('Erreur audio système:', err);
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                document.getElementById('audio-info').textContent = 'Partage audio refusé';
            } else {
                document.getElementById('audio-info').textContent = 'Erreur audio système';
            }
        }
    }

    function toggleMic() {
        if (isMicActive) {
            stopMic();
        } else {
            startMic();
        }
    }

    function toggleSystemAudio() {
        if (isSystemActive) {
            stopSystemAudio();
        } else {
            startSystemAudio();
        }
    }

    function stopMic() {
        if (microphone) {
            microphone.disconnect();
            microphone = null;
        }
        isMicActive = false;
        document.getElementById('mic-toggle').classList.remove('text-neon-green');
        document.getElementById('mic-toggle').classList.add('text-text-dark');
        updateAudioInfo();
        checkIfShouldStop();
    }

    function stopSystemAudio() {
        if (systemAudio) {
            systemAudio.disconnect();
            systemAudio = null;
        }
        isSystemActive = false;
        document.getElementById('system-toggle').classList.remove('text-neon-green');
        document.getElementById('system-toggle').classList.add('text-text-dark');
        updateAudioInfo();
        checkIfShouldStop();
    }

    function checkIfShouldStop() {
        if (!isMicActive && !isSystemActive) {
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                analyser = null;
            }
            // Effacer le canvas
            canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        }
    }

    function updateAudioInfo() {
        const info = document.getElementById('audio-info');
        if (isMicActive && isSystemActive) {
            info.textContent = 'Micro + Système actifs';
        } else if (isMicActive) {
            info.textContent = 'Micro actif';
        } else if (isSystemActive) {
            info.textContent = 'Système actif';
        } else {
            info.textContent = 'Audio désactivé';
        }
    }

    function draw() {
        if (!isMicActive && !isSystemActive) return;
        
        requestAnimationFrame(draw);
        
        analyser.getByteFrequencyData(dataArray);
        
        // Fond avec effet de traînée
        canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        
        const barWidth = (canvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;
        
        for (let i = 0; i < bufferLength; i++) {
            barHeight = (dataArray[i] / 255) * canvas.height * 0.8;
            
            // Gradient de couleur selon la fréquence
            const hue = (i / bufferLength) * 180 + 180; // De cyan à vert
            canvasCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            
            // Dessiner la barre depuis le bas
            canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            
            // Effet de reflet en haut
            canvasCtx.globalAlpha = 0.3;
            canvasCtx.fillRect(x, 0, barWidth, barHeight * 0.3);
            canvasCtx.globalAlpha = 1.0;
            
            x += barWidth + 1;
        }
    }
</script>
</body>
</html>